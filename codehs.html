    <html>
        <head>
            <title>Your Program Title</title>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
            <script type="text/javascript" src="https://static.codehs.com/gulp/80550f5fc4071985bfef352d04f005ca3de931d3/chs-js-lib/chs.js"></script>
            <style>
                canvas {
                    border: 1px solid 
black;
                    display: inline-block;
                    vertical-align: top;
                }
                pre {
                    border: 1px solid 
black;
                    display: inline-block;
                    width: 400px;
                    height: 500px;
                    background-color: 
#F5F5F5;
                }
            </style>
    </head>
    <body>
        <h1>Your Program Title</h1>
        <canvas
        width="400"
        height="500"
        class="codehs-editor-canvas"></canvas>
        <pre id="console"></pre>

        <script>
            window.onload = function() {
                const gravity = -.5;
const friction = 0.5;

const xAcceleration = 1;
const xSpeedLimit = 5;
const jumpHeight = 8;
const terminalVel = 15;

const portalWidth = 60;
const portalMargin = 0;
const portalTeleWidth = 10;
const portalExtraWidth = 10;

const charProp = [20, 40];
var charVel = [0, 0];
var cursorPos = [0, 0]

var keyA = false; //left
var keyD = false; //right
var keyW = false; //jump

var keyQ = false; //primary
var keyE = false; //secondary

var inPortal = false;

var Ob = rect(100, 50, getWidth()/2-50, getHeight()-50, "yellow");

var line = new Line(getWidth()/2, getHeight()/2, 0, 0);
line.setColor("#aaaaaa")
add(line);


var char = rect(charProp[0],charProp[1],getWidth()/2-charProp[0]/2, getHeight()-charProp[1], "black");

var port1 = rect(10, portalWidth, 0, -200, "#0000ff")
var port2 = rect(10, portalWidth, 0, -200, "#ff7700")

var portalFlip = [1, 1, 0];

var Map = []

//0 - null
//1 - left
//2 - right
//3 - top
//4 - bottom

//todo:
// Floor portal tele
// Map collision
// Map portal collision
//  - Round to nearest line on face


var port1Face = ""
var port2Face = ""

function start() {
    
    
    mouseMoveMethod(function(e){
        cursorPos[0] = e.getX()
        cursorPos[1] = e.getY()
        updatePointer();
    });
    
    keyDownMethod(function(e){
        switch(e.key){
            case "a": {
                keyA = true;
                break;
            }
            case "d": {
                keyD = true;
                break;
            }
            case "w": {
                keyW = true;
                break;
            }
            case "q": {
                keyQ = true;
                break;
            }
            case "e": {
                keyE = true;
                break;
            }
        }
    });
    
    keyUpMethod(function(e){
        switch(e.key){
            case "a": {
                keyA = false;
                break;
            }
            case "d": {
                keyD = false;
                break;
            }
            case "w": {
                keyW = false;
                break;
            }
            case "q": {
                keyQ = false;
                break;
            }
            case "e": {
                keyE = false;
                break;
            }
        }
    });
    
    setTimer(function(){
        
        const portalsActive = (port1Face != "" && port2Face != "")
        
        const isOnGround = (char.getY() >= getHeight()-charProp[1])
        if(keyA && charVel[0] >= -xSpeedLimit && isOnGround){ //acceleration
            charVel[0] -= xAcceleration;
        }else if(keyD && charVel[0] <= xSpeedLimit && isOnGround){
            charVel[0] += xAcceleration;
        // }else if(keyA && charVel[0] >= -xSpeedLimit && !isOnGround){
        //     charVel[0] -= 0.2;
        // }else if(keyD && charVel[0] <= xSpeedLimit && !isOnGround){
        //     charVel[0] += 0.2;
        }else if(charVel[0] > 0 && isOnGround) { //friction
            charVel[0] -= friction;
        }else if(charVel[0] < 0 && isOnGround){
            charVel[0] += friction;
        }
        
        //left wall collision
        const leftHoleB = (port1Face == "Left" && portalsActive && char.getY() < port1.getY()+portalWidth-charProp[1]+portalExtraWidth && char.getY()+10 > port1.getY()-portalExtraWidth)
        const leftHoleO = (port2Face == "Left" && portalsActive && char.getY() < port2.getY()+portalWidth-charProp[1]+portalExtraWidth && char.getY()+10 > port2.getY()-portalExtraWidth)
        if(char.getX() < 0 && !leftHoleB && !leftHoleO){
            charVel[0] = 0;
            char.setPosition(0, char.getY());
        }
        
        //right wall collision
        const rightHoleB = (port1Face == "Right" && portalsActive && char.getY() < port1.getY()+portalWidth-charProp[1]+portalExtraWidth && char.getY() > port1.getY()-portalExtraWidth)
        const rightHoleO = (port2Face == "Right" && portalsActive && char.getY() < port2.getY()+portalWidth-charProp[1]+portalExtraWidth && char.getY() > port2.getY()-portalExtraWidth)
        if(char.getX()+charProp[0] > getWidth() && !rightHoleB && !rightHoleO){
            charVel[0] = 0;
            char.setPosition(getWidth()-charProp[0], char.getY());
        }
        
        //Gravity
        if(charVel[1] <= terminalVel){// Falling
            charVel[1] = charVel[1] - gravity
        }
        
        //Floor collision
        const botHoleB = (port1Face == "Bottom" && portalsActive && char.getX() < port1.getX()+portalWidth-charProp[0]*2+portalExtraWidth && char.getX() > port1.getX()-charProp[0]-portalExtraWidth)
        const botHoleO = (port2Face == "Bottom" && portalsActive && char.getX() < port2.getX()+portalWidth-charProp[0]*2+portalExtraWidth && char.getX() > port2.getX()-charProp[0]-portalExtraWidth)

        if(char.getY() >= getHeight()-charProp[1] && !botHoleB && !botHoleO){ // Floor Collision
            charVel[1] = 0;
            char.setPosition(char.getX(), getHeight()-charProp[1]);
        }
        
        //jump
        if(keyW && char.getY() > getHeight()-charProp[1]-1 && !botHoleB && !botHoleO) {
            charVel[1] = -jumpHeight;
            char.move(0, -jumpHeight);
        }
        
        //Roof collision
        
        //Map Collision
        
        
        //Portals Left & Right
        const wbPortalBounds = ((port1Face == "Left" || port1Face == "Right") && inBounds(14, portalWidth-portalMargin, port1.getX(), port1.getY()-portalMargin, char.getX()+charProp[0]/2, char.getY()+charProp[1]/2))
        const woPortalBounds = ((port2Face == "Left" || port2Face == "Right") && inBounds(14, portalWidth-portalMargin, port2.getX(), port2.getY()-portalMargin, char.getX()+charProp[0]/2, char.getY()+charProp[1]/2))
        
        if(!inPortal && wbPortalBounds) {//blue Portal
            const wbPlayerOffset = port1.getY() - char.getY();
            char.setPosition(port2.getX()-charProp[0], port2.getY()-wbPlayerOffset);
            var flip = pFlip(charVel[0], charVel[1])
            charVel[0] = flip[0]
            charVel[1] = flip[1];
            char.move(charVel[0], charVel[1]);
            inPortal = true;
        }else if(!inPortal && woPortalBounds) { //Orange Portal
            const woPlayerOffset = port2.getY() - char.getY();
            char.setPosition(port1.getX()-charProp[0], port1.getY()-woPlayerOffset);
            var flip = pFlip(charVel[0], charVel[1])
            charVel[0] = flip[0]
            charVel[1] = flip[1];
            char.move(charVel[0], charVel[1]);
            inPortal = true;
        } 
        
        
        const fbPortalBounds = ((port1Face == "Top" || port1Face == "Bottom") && inBounds(portalWidth, 14, port1.getX(), port1.getY()+7, char.getX(), char.getY()))
        const foPortalBounds = ((port2Face == "Top" || port2Face == "Bottom") && inBounds(portalWidth+charProp[0], 14, port2.getX()-charProp[0]/2, port2.getY()+7, char.getX()+charProp[0]/2, char.getY()))

        if(fbPortalBounds) {//blue Portal
            const fbPlayerOffset = port1.getX() - char.getX();
            char.setPosition(port2.getX()-charProp[0]-fbPlayerOffset, port2.getY()+20);
            var flip = pFlip(charVel[0], charVel[1])
            charVel[0] = flip[0];
            charVel[1] = flip[1];
            char.move(charVel[0], charVel[1]);
            inPortal = true;
        }else if(foPortalBounds) { //Orange Portal
            const foPlayerOffset = port2.getX() - char.getX();
            char.setPosition(port1.getX()-charProp[0]-foPlayerOffset, port1.getY()+20);
            var flip = pFlip(charVel[0], charVel[1])
            charVel[0] = flip[0]
            charVel[1] = flip[1];
            char.move(charVel[0], charVel[1]);
            inPortal = true;
        } 
        
        if(inPortal && !wbPortalBounds && !woPortalBounds && !fbPortalBounds && !foPortalBounds){
            inPortal = false;
        }
        
        
        char.move(charVel[0], charVel[1]);
        updatePointer()
        line.setPosition(char.getX()+charProp[0]/2, char.getY()+5);
        
    }, 10)
}

function updatePointer() {
    var pos = rayCastPos(char.getX()+charProp[0]/2, char.getY()+5, cursorPos[0], cursorPos[1]);
    
    if(pos[0]*0 != 0 || pos[1]*0 != 0){
        return;
    }
    
    // println(pos[0] + " " + pos[1])
    
    line.setPosition(char.getX()+charProp[0]/2, char.getY()+5);
    line.setEndpoint(pos[0], pos[1]);
    
    //Primary particle
    if(keyE){
        keyE = false;
        var particle = {
            x: 0,
            p: newLine(char.getX()+charProp[0]/2, line.getY(), pos[0], pos[1]),
            func: function() {
                if(particle.x < 255){
                    particle.p.setColor(new Color(particle.x, particle.x, 255));
                    particle.x += 8;
                }else if(particle.x == 256){
                    remove(particle.p);
                    particle.x = -1;
                }
            },
        };
        
        setTimer(particle.func, 10)
        port1Face = pos[2];
        
        if(port1Face == "Bottom" || port1Face == "Top"){
            port1.setRotation(90);
        }else{
            port1.setRotation(0);
        }
        
        port1.setPosition(pos[0]-5, pos[1]-portalWidth/2)
        
    }
    
    //Secondary particle
    if(keyQ){
        keyQ = false;
        
        var particle = {
            x: 0,
            p: newLine(char.getX()+charProp[0]/2, line.getY(), pos[0], pos[1]),
            func: function() {
                if(particle.x < 255){
                    particle.p.setColor(new Color(255, particle.x/2+127, particle.x));
                    particle.x += 8;
                }else if(particle.x == 256){
                    remove(particle.p);
                    particle.x = -1;
                }
            },
        };
        
        setTimer(particle.func, 10)
        
        port2Face = pos[2];
        
        if(port2Face == "Bottom" || port2Face == "Top"){
            port2.setRotation(90);
        }else{
            port2.setRotation(0);
        }
        
        port2.setPosition(pos[0]-5, pos[1]-portalWidth/2)
    }
}

function pFlip(x, y){
    var fx = 0;
    var fy = 0;
    var pflipX = 1;
    var pflipY = 1;
    const bWall = (port1Face == "Left" || port1Face == "Right");
    const oWall = (port2Face == "Left" || port2Face == "Right");
    const bFloor = (port1Face == "Top" || port1Face == "Bottom");
    const oFloor = (port2Face == "Top" || port2Face == "Bottom");
    if(bWall && oWall){
        if(port1Face == port2Face){
            pflipX = -1;
        }
        if(charVel[0] <= 4){
            charVel[0] = charVel[0] + 5
        }
        println(charVel[0])
        fx = x * pflipX;
        fy = y * pflipY;
    }else if(bFloor && oFloor){
        fx = x;
        fy = y * -1;
    }
    return [fx, fy];
}

function rayCastPos(x1, y1, x2, y2){
    var rad = (y2 - y1) / (x2 - x1);
    var frac = toFraction(rad, (x2 > x1));
    var fracX = frac[1]*-1;
    var fracY = frac[0]*-1;

    while(Math.abs(fracX) > 10 || Math.abs(fracY) > 10 ){
        fracX = fracX / 10
        fracY = fracY / 10
    }

    var x = x1;
    var y = y1;
    while(true){
            
        if(x >= getWidth()){
            return [x, y, "Right"];
            break;
        }else if(x <= 0){
            return [x, y, "Left"];
            break;
        }else if(y >= getHeight()){
            return [x, y, "Bottom"];
            break;
        }else if(y <= 0){
            return [x, y, "Top"];
            break;
        }else{
            x = x + fracX;
            y = y + fracY;
        }
    }
}

function rect(w, h, x, y, c){
    var rect = new Rectangle(w, h)
    rect.setPosition(x, y);
    rect.setColor(c);
    add(rect);
    return rect
}

function newLine(x1, y1, x2, y2){
    var li = new Line(x1, y1, x2, y2);
    add(li);
    return li;
}


function inBounds(w, h, x, y, x2, y2){
    const isX = x2 <= x+w && x2 >= x;
    const isY = y2 <= y+h && y2 >= y;
    if(isX && isY){
        return true;
    }else{
        return false;
    }
    // var boundingbox = new Rectangle(w, h)
    // boundingbox.setColor("black")
    // boundingbox.setPos(x, y)
    // add(boundingbox)

}

function gcd(a, b) {
	return (b) ? gcd(b, a % b) : a;
}

function toFraction(x, invert){
    if (x == 0) return [0, 1];
    if (x*0 != 0) return [1, 0];

    const a = Math.abs(x);
    let n = 0;
    let d = 1;
    let r;
    while (true) {
        r = n / d;
        if (Math.abs((r - a) / a) < 0.0001) {
            break;
        }
        if (r < a) {
            n++;
        }
        else {
            d++;
        }
    }
    n = (x < 0 ? -n : n)
    return [invert ? -n : n, invert ? -d : d];
}
                if (typeof start === 'function') {
                    start();
                }
            };
        </script>
    </body>
